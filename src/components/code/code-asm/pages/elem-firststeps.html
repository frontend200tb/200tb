<h1>Конспект канала First Steps</h1>


<!-- Содержание -->
<div class="article article__content">
  <h2>Содержание</h2>

  <p><a href="#links">links</a></p>
  <p><a href="#about">about</a></p>
  <p><a href="#install">install</a></p>
  <p><a href="#fasm64">fasm64</a></p>
  <p><a href="#pellesc">Pelles C</a></p>
  <p><a href="#small">Уменьшение размера исполняемого файла</a></p>
</div>


<!-- links -->
<article class="article">
  <div class="anchor" id="links"></div>
  <h3>links</h3>

  <ul>
    <li><a href="https://assembler-code.com">https://assembler-code.com</a></li>
    <li><a href="https://www.youtube.com/@firststepsforward/videos">https://www.youtube.com/@firststepsforward/videos</a></li>
  </ul>
</article>


<!-- about -->
<article class="article">
  <div class="anchor" id="about"></div>
  <h3>about</h3>

</article>


<!-- install -->
<article class="article">
  <div class="anchor" id="install"></div>
  <h3>install</h3>

  <h4>Установим среду разработки на ассемблере <strong>RedAsm</strong></h4>
  <ol>
    <li>
      <p>Заходим на сайт</p>
      <code><a href="https://assembler-code.com/programmnoe-obespechenie/">https://assembler-code.com/programmnoe-obespechenie/</a></code>
    </li>
    <li>
      <p>Скачиваем файл</p>
      <code>FASM64.exe</code>
    </li>
    <li>
      <p>Запускаем файл. Пароль к архиву как и название сайта</p>
      <code>assembler-code.com</code>
    </li>
    <li>
      <p>В конце установке запустится программа installer, которая спросит каким ассемблером мы будем пользоваться по умолчанию и выполнит соответствующие настройки RedAsm. Выбираем MASM32 - мы начнем с него. Впрочем, при создании проекта всегда можно выбрать любой другой ассемблер.</p>
    </li>
  </ol>

  <h4>Установим среду разработки для языка Си <strong>Pelles C</strong></h4>
  <ol>
    <li>
      <p>Заходим на сайт</p>
      <code><a href="https://www.smorgashbordet.com/pellesc/">https://www.smorgashbordet.com/pellesc/</a></code>
    </li>
    <li>
      <p>Скачиваем и устанавливаем в одну директорию с FASM64</p>
    </li>
  </ol>

  <h4>Почему RedAsm и Pelles C</h4>
  <ol>
    <li>Они неприхотливы к компьютеру</li>
    <li>Совместимы с ОС от Windows XP до Windows 11</li>
    <li>В них встроены программы для работы с ресурсами. Для удобного и быстрого решения наших задач</li>
    <li>Они имеют нормальные системы подсказок, автозаполнения кода</li>
    <li>Генерируют очень маленькие по размеру, необогащенные мусором программы, с ясным, неизбыточным кодом</li>
    <li>Их можно перенести в любую папку или даже на флешку</li>
  </ol>
</article>


<!-- fasm64 -->
<article class="article">
  <div class="anchor" id="fasm64"></div>
  <h3>fasm64</h3>

  <p>Основа пакета FASM64 среда разработки для ассемблера RedAsm. Это лучшая среда для Windows проектов на сегодняшний день. Она поддерживает практически все популярные ассемблеры, включая MASM32 и FASM. Которыми мы будем пользоваться и которые предустановлены и настроены в пакете. Имеются все необходимые утилиты для создания, изучения и работы с 32 и 64 битными программами для windows. Так что ничего искать и скачивать не придется.</p>

  <h4>Создадим программу в среде разработки RedAsm на языке ассемблера MASM32</h4>
  <ol>
    <li>
      <p>Запустим программу RedAsm</p>
      <code>FASM64\RedAsm2\RedAsm.exe</code>
    </li>
    <li>
      <p>Создадим новый проект. Выбираем меню</p>
      <code>File - New Project (Ctrl+Shift+N)</code>
    </li>
    <li>
      <p>Откроется окно Project Wizzard - Type & Name</p>
      <p>Выбираем ассемблер для нового проекта</p>
      <code>Assembler - masm</code>
      <p>Выбираем тип проекта</p>
      <code>Project Type - Win32 App</code>
      <p>Пишем название проекта</p>
      <code>Project Name - Hello</code>
      <code>Project - Hello</code>
      <p>По умолчанию выбрана директория проекта</p>
      <code>Project Folder - d:\Programs\FASM64\RadAsm2\Fasm\Projects\</code>
      <p>Но ее можно изменить и мы зададим свою</p>
      <code>Project Folder - D:\code\assembler</code>
      <p>Нажимаем кнопку</p>
      <code>Далее</code>
    </li>
    <li>
      <p>Откроется окно Project Wizzard - Template</p>
      <p>Выбираем шаблон</p>
      <code>MessageBox.tpl</code>
      <p>Нажимаем кнопку</p>
      <code>Далее</code>
    </li>
    <li>
      <p>Откроется окно Project Wizzard - Files & Folders</p>
      <p>Выберем файлы</p>
      <code>File Creation - Asm, Inc, Txt</code>
      <p>Нажимаем кнопку</p>
      <code>Далее</code>
    </li>
    <li>
      <p>Откроется окно Project Wizzard - Make</p>
      <p>Выбираем</p>
      <code>Make Menu - Assemble, Link, Buid, Go, Run, Run w/debug</code>
      <p>Нажимаем кнопку</p>
      <code>Готово</code>
    </li>
    <li>
      <p>В директории D:\code\assembler, которую мы выбрали создастся папка Hello. В папке Hello создадутся файлы Hello.Asm, Hello.Inc, Hello.rap и Hello.Txt</p>
    </li>
    <li>
      <p>В окне Project Browser нажимаем на файл</p>
      <code>Helo.Asm</code>
      <p>Файл откроется в окне редактора</p>
    </li>
    <li>
      <p>Мы увидим код первой программы</p>
<pre>.386
.model flat, stdcall
option casemap:none

include Hello.Inc

.code
start:
    invoke MessageBox, NULL, addr MsgBoxText, addr MsgCaption, MB_OK
    invoke ExitProcess, NULL
end start</pre>
      <p>Этот код директивой include включает еще и код из файл Hello.Inc</p>
<pre>include windows.inc
include kernel32.inc
include user32.inc
includelib user32.lib
includelib kernel32.lib

.data
MsgCaption      db "Smalest Prog",0
MsgBoxText      db "Win32 Assembly is Great!",0</pre>
    </li>
    <li>
      <p>Выполним ассемблирование</p>
      <p>На панели инструментов нажимаем кнопку</p>
      <code>Assemble</code>
      <p>То же самое можно сдлать выбрав пункт меню</p>
      <code>Make - Assemble (f5)</code>
      <p>В окне Output Window видим, что наш код Hello.Asm обработала программа ассемблер masm32\Bin\ML.EXE. Еще ее называют компоновщик или транслятор.</p>
      <p>Ассемблер ML.EXE создал объектный файл Hello.obj</p>
    </li>
    <li>
      <p>Выполним линковку</p>
      <p>Перед линковкой обязательно нужно делать ассемблирование, чтобы ассемблер создал объектный файл Hello.obj</p>
      <p>Выбираем пункт меню</p>
      <code>Make - Link (Alt+Ctrl+F5)</code>
      <p>В окне Output Window видим, что объектный файл Hello.obj обработала  программа компилятор masm32\Bin\LINK.EXE. Еще ее называют линковщик или сборщик.</p>
      <p>Компилятор LINK.EXE создал исполняемый файл Hello.exe</p>
    </li>
    <li>
      <p>Выполним компиляцию</p>
      <p>Выполнить компиляцию (ассемблирование и линковку) можно одной командой</p>
      <p>На панели инструментов нажимаем кнопку</p>
      <code>Build</code>
      <p>То же самое можно сдлать выбрав пункт меню</p>
      <code>Make - Build (Alt+Shift+F5)</code>
      <p>В окне Output Window видим, что сначала наш код Hello.Asm обработала  программа ассемблер masm32\Bin\ML.EXE, которая создала объектный файл Hello.obj. Затем объектный файл Hello.obj обработала программа линковщик masm32\Bin\LINK.EXE, которая создала исполняемый файл Hello.exe.</p>
      <p>Теперь программа скомпилирована и собрана. Для компиляции осуществляется два прохода - два этапа сборки программы. MASM32 использует компоновщик и линкер - это компиляция двумя проходами. FASM осуществляет один проход. Он включает в себя и компоновку и линковку.
      </p>
    </li>
    <li>
      <p>Запустим исполняемый файл Hello.exe</p>
      <p>На панели инструментов нажимаем кнопку</p>
      <code>Run</code>
      <p>То же самое можно сдлать выбрав пункт меню</p>
      <code>Make - Run (Ctrl+Shift+F5)</code>
    </li>
    <li>
      <p>Видим результат работы нашей программы. Открывается окно Smallest Prog с сообщением Win32 Assembly is Great! и кнопкой ОК</p>
    </li>
  </ol>

  <h4>Разберем код первой программы</h4>
  <h4>.386</h4>
  <p>Ассемблер использует инструкции доступные для процессора Intel 80386 и более новых. Можно изменить на .486 или .586</p>
  <h4>.model flat</h4>
  <p>Использование плоской модели памяти. Эту модель памяти использует Windows</p>
  <h4>stdcall</h4>
  <p>Определяет соглашение о вызове функций. Функция после вызова сама очищает стек. Параметры функции передаются через стек справа налево. Используется в языках программирования Си и C++ при работе с WinAPI</p>
  <h4>option casemap:none</h4>
  <p>Имена меток нечувствительны к регистру. Ассемблер будет одинаково воспринимать заглавные и строчные буквы</p>
  <h4>include Hello.Inc</h4>
  <p>На место этой строки в программе будет содержимое файла Hello.Inc</p>
  <p>Использование отдельных файлов для кода и отдельных для объявления функций, переменных, макросов, вложение библиотек предпочтительнее. Это облегчает написание сложных программ и говорит о высоком профессионализме</p>
  <h4>.code</h4>
  <p>Начало секции кода</p>
  <h4>.data</h4>
  <p>Секция данных</p>
  <h4>MsgCaption      db "Smalest Prog",0</h4>
  <p>Ноль-терминированная строка. Это строка которая оканчивается нулем.</p>
  <h4>start:</h4>
  <p>Начало секции кода</p>
  <h4>end start</h4>
  <p>Конец секции кода. Все что находится ниже этой строки ассемблером не воспринимается</p>
  <h4>invoke MessageBox</h4>
  <p>Функция Win32Api. Вызывает окно MessageBox</p>
  <h4>invoke ExitProcess</h4>
  <p>Функция Win32Api. Завершает процесс нашей программы. Программа корректно заканчивает свою работу в Windows</p>
</article>


<!-- pellesc -->
<article class="article">
  <div class="anchor" id="pellesc"></div>
  <h3>Pelles C</h3>

  <h4>Создадим программу в среде разработки Pelles C на языке Си</h4>
  <ol>
    <li>
      <p>Запустим программу Pelles C</p>
      <code>PellesC/Bin/poide.exe</code>
    </li>
    <li>
      <p>Создадим новый проект. Выбираем меню</p>
      <code>File - New - Project</code>
    </li>
    <li>
      <p>Откроется окно New project</p>
      <p>Выбираем пустой проект</p>
      <code>Empty projects - Win32 Program (EXE)</code>
      <p>Пишем название проекта</p>
      <code>Name - Hello</code>
      <p>По умолчанию выбрана директория проекта</p>
      <code>Location - d:\Programs\PellesC\MyProjects\Hello</code>
      <p>Но ее можно изменить и мы зададим свою</p>
      <code>Location - D:\code\c\</code>
      <p>Нажимаем кнопку</p>
      <code>OK</code>
    </li>
    <li>
      <p>В директории D:\code\c, которую мы выбрали создастся папка Hello. В папке Hello создадутся файлы Hello.ppj, Hello.ppx</p>
    </li>
    <li>
      <p>На вкладке Source files клик правой кнопкой мыши по файлу проекта Hello.ppj и выбираем</p>
      <code>Add files to project</code>
    </li>
    <li>
      <p>Откроется окно Add files. Напишем имя файла</p>
      <code>Имя файла - Hello.c</code>
      <p>Нажимаем кнопку</p>
      <code>Открыть</code>
    </li>
    <li>
      <p>В папке Hello появятся два новых файла Hello.c и Hello.tag</p>
      <p>На вкладке Source files появится папка Source files, а в ней файл Hello.c. Нажмем на него чтобы он открылся в окне редактора</p>
    </li>
    <li>
      <p>Напишем в нем первую программу</p>
<pre>#include &lt;windows.h&gt;
#pragma comment(linker, "/ENTRY:MyWinMain")

void MyWinMain()
{
  MessageBox(0, Win32 Assembly is Great!", "Smallest Prog", MB_OK);
  ExitProcess(0);
}</pre>
    </li>
    <li>
      <p>Выполним компиляцию</p>
      <p>На панели инструментов нажимаем кнопку</p>
      <code>Build</code>
      <p>То же самое можно сдлать выбрав пункт меню</p>
      <code>Project - Build (Ctrl+B)</code>
    </li>
    <li>
      <p>Компилятор создаст исполняемый файл , а также папку output с объектным файлом Hello.obj</p>
      <p>Запустим исполняемый файл Hello.exe</p>
      <p>На панели инструментов нажмем кнопку</p>
      <code>Execute</code>
      <p>То же самое можно сдлать выбрав пункт меню</p>
      <code>Project - Execute (Ctrl+F5)</code>
    </li>
    <li>
      <p>Видим результат работы нашей программы. Открывается окно Smallest Prog с сообщением Win32 Assembly is Great! и кнопкой ОК</p>
    </li>
  </ol>
</article>


<!-- Уменьшение размера исполняемого файла -->
<article class="article">
  <div class="anchor" id="small"></div>
  <h3>Уменьшение размера исполняемого файла</h3>

  <h4>1. Объединяем секции, удаляем ненужные</h4>
  <p>В каждом исполняемом файле линкером LINK.EXE создаются секции для кода, данных, импорта, экспорта, ресурсов. Они могут иметь названия .text, .rdata, .data, .reloc и другие. Даже если в этих секциях нет необходимости, они будут по умолчанию создаваться линкером. Эти секции можно объединять в одну. Или давать команду линкеру не создавать конкретную секцию. Размер файла существенно уменьшится. Практически, безопасно данные помещать в секцию кода. Это затрудняет отладку исполняемых файлов, что является одним из способов защиты от взлома.</p>
  <p>После того как мы создали первую программу на ассемблере, у нас есть исполняемый файл Hello.exe. Откроем его в текстовом редакторе с кодировкой ANSII.</p>

  <h4>2. Задаем минимальное число выравнивания секций</h4>
  <p>Каждая секция выравнивается в памяти на значение, кратное определенному числу. По умолчанию это значение 4096 для 32 битной системы. Указатель на первый байт секции, даже если в ней не будет данных переместится на адрес кратный 4096. Данные будут проецироваться напрамую в память из нашего файла. Если изменить кратность выравнивания, изменится как проецируемый файл в памяти, так и файл на жестком диске. Минимальное значение выравнивания в 32 битной системе 16 байт. При помощи линкера LINK.EXE можно установить минимальное значение выравнивания.</p>

  <h4>3. Убираем уведомление для DOS</h4>
  <p>В начале любого исполняемого файла в среде Windows есть секция с фразой This program cannot be run in DOS mode. Этот текст выведет консоль если файл запустят в системе DOS. В линкере можно убрать вывод этого текста.</p>

  <h4>4. Используем Win32API</h4>
  <p>В коде надо использовать функции, содержащиеся в самой операционке, библиотеках dll, а не писать свой код. При вызове функций Win32API, код функций берется из библиотеки dll, его нет в коде нашей программы, что также уменьшает ее размер.</p>

  <h4>5. Используем секцию .data? (для MASM32)</h4>
  <p>При написании больших программ, необходимо, если возможно, выделять память динамически. Или размещать в ней инициализированные данные в специальной секции <strong>.data?</strong> а не в секции данных <strong>.data</strong></p>

  <h4>6. Применяем неординарные способы</h4>
  <p>Применять неординарные способы уменьшения размера программ. Например грубая обрезка файла.</p>

  <h4>Переходим к Практике</h4>
  <p>Линковщик ассемблера использует только командную строку. А линковщик PellesC поддерживает директиву #pragma, что очень удобно</p>
</article>

